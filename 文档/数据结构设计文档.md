# 数据结构设计

## 节点数据

```javascript
// 每个节点包含
{
  // 卡片笔记
  cardNotes: [
    {
      path: "项目语境/2025-01/15-学习笔记.md",
      basename: "15-学习笔记",
      addedAt: "2025-01-15"
    }
  ],

  // 每日活动（按日期记录）
  dailyActivity: {
    "2025-01-15": {
      cardLinksAdded: 3,           // 当天新增卡片数
      masteryTriggered: true,      // 是否掌握（二元状态）
      isFirstMastery: true         // 是否首次掌握
    }
  },

  // 统计缓存（数据变更时维护）
  cachedStats: {
    totalDescendantCards: 25,      // 子树卡片总数
    maxDescendantMastery: 0.85     // 子树最高熟悉度
  }
}
```

## 掌握逻辑

- 首次学习：当天≥3张卡片 → 掌握
- 复习：当天≥1张卡片 → 掌握
- 熟悉度：基于最后掌握日期的遗忘曲线

## 核心函数

```javascript
// 添加卡片（同时维护统计）
function addCardToNode(nodeId, cardInfo) {
  node.cardNotes.push(cardInfo)
  node.dailyActivity[today].cardLinksAdded++
  updateAncestorStats(nodeId, +1)  // 递归更新父节点统计
  checkAndTriggerMastery(nodeId, today)
}
```

## 时间演绎动画

- 基于时间轴的展开/收缩控制
- 有活动的节点：展开显示
- 无活动的节点：收缩隐藏
- 收缩的父节点：显示 cachedStats 聚合数字

## 性能策略

- 写时维护统计，读时直接用
- 避免懒计算和实时遍历
- 分层渲染：焦点区域完整，远离区域简化